# AI 黄金价格预测 × Polymarket 回测系统

> 基于 AI 回归模型预测黄金价格涨跌，并在 Polymarket 预测市场上进行自动化交易回测。

---

## 一、项目概述

本系统包含两大核心功能：

1. **实时预测**：融合 AI 定性分析 + Logistic 回归模型，预测指定日期的黄金价格涨跌概率
2. **历史回测**：在 Polymarket 的 Gold (GC) Up/Down 二元事件上，模拟每小时交易决策，验证策略盈利能力

---

## 二、系统架构

```
┌──────────────────────────────────────────────────────────────┐
│                      数据层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────────┐  │
│  │ Yahoo Finance│  │ 新闻 RSS    │  │ Dome API (Polymarket)│  │
│  │ 金价 + 宏观  │  │ 黄金相关新闻│  │ 事件 + K线价格       │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬───────────┘  │
│         │                │                     │              │
├─────────┼────────────────┼─────────────────────┼──────────────┤
│         ▼                ▼                     │              │
│  ┌─────────────────────────────┐               │   预测层     │
│  │  AI 因素收集 + 深度分析      │               │              │
│  │  (Qwen / OpenAI 大模型)     │               │              │
│  └──────────┬──────────────────┘               │              │
│             ▼                                  │              │
│  ┌─────────────────────────────┐               │              │
│  │  Logistic 回归模型           │               │              │
│  │  10个宏观指标 × 365天窗口    │               │              │
│  │  输出: P(Up) 上涨概率        │               │              │
│  └──────────┬──────────────────┘               │              │
│             │                                  │              │
├─────────────┼──────────────────────────────────┼──────────────┤
│             ▼                                  ▼   回测层     │
│  ┌───────────────────────────────────────────────────────┐   │
│  │  回测引擎                                               │   │
│  │  模型概率 vs Polymarket 市场定价 → Edge → 交易决策       │   │
│  │  每小时检查 × 严格模式 × 置信度过滤                      │   │
│  └───────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

---

## 三、预测模型

### 3.1 预测流程（8 步）

| 步骤 | 模块 | 说明 |
|------|------|------|
| 1 | `price_fetcher.py` | 获取 365 天历史黄金价格（Yahoo Finance） |
| 2 | `news_fetcher.py` | 抓取最近 3 天黄金相关新闻（RSS） |
| 3 | `factor_collector.py` | AI 大模型基于新闻提取影响金价的关键因素 |
| 4 | `deep_analyzer.py` | AI 大模型做深度分析，输出看涨/看跌倾向 |
| 5 | `factor_data.py` | AI 将定性因素映射到可量化的代理指标 |
| 6 | `factor_data.py` | 爬取 10 个宏观代理指标的日度数据 |
| 7 | `regression.py` | 构建特征矩阵，训练 Logistic 回归，输出 P(Up) |
| 8 | `regression.py` | 融合回归定量结果 + AI 定性判断 → 最终概率 |

### 3.2 模型特征（10 个宏观代理指标）

| 指标 | 代码 | 与金价关系 | AI 权重 |
|------|------|-----------|---------|
| 美国 10Y 国债收益率 | `us_10y_yield` | 负相关 | 8 |
| 美元指数 | `dxy_index` | 负相关 | 9 |
| VIX 恐慌指数 | `vix` | 正相关 | 7 |
| 美国 2Y 国债收益率 | `us_2y_yield` | 负相关 | 6 |
| 白银价格 | `silver` | 正相关 | 6 |
| 标普 500 | `sp500` | 负相关 | 5 |
| TIPS 通胀保值债券 | `tips_etf` | 正相关 | 5 |
| 原油价格 | `oil_wti` | 正相关 | 4 |
| 铜价格 | `copper` | 正相关 | 4 |
| 黄金 ETF 成交量 | `gld_volume` | 正相关 | 3 |

### 3.3 模型方法

- **算法**：Logistic 回归（sklearn LogisticRegression）
- **训练窗口**：365 天滚动窗口
- **标签**：未来 N 天金价涨跌（二分类）
- **特征工程**：每个代理指标的日收益率 + 滞后特征
- **预测输出**：`P(Up)` 上涨概率（0~1）

### 3.4 运行实时预测

```bash
python gold_analyzer/main.py
# 输入预测目标日期，例如: 2026-02-10
# 输出: 完整分析报告 + JSON 文件
```

---

## 四、交易策略

### 4.1 交易标的

Polymarket 上每个交易日有一个二元事件：**"Gold (GC) Up or Down on [日期]?"**

- **Up token**：当天金价上涨 → 结算价 $1；下跌 → 结算价 $0
- **Down token**：当天金价下跌 → 结算价 $1；上涨 → 结算价 $0
- 两个 token 价格之和 ≈ $1（互补关系）

### 4.2 交易决策流程

```
┌─────────────────────────────────────────────────────┐
│  Step 1: 站在前一天，运行 AI 回归模型                    │
│  输入: 365天历史金价 + 10个宏观指标                      │
│  输出: P(Up) = 模型预测的上涨概率                        │
│  例: P(Up) = 83% → 模型预测方向 = Up                    │
├─────────────────────────────────────────────────────┤
│  Step 2: 每小时检查 Polymarket 市场定价                  │
│  读取: Up token 当前价格（= 市场隐含上涨概率）             │
│  例: Up token = $0.55 → 市场认为上涨概率 55%             │
├─────────────────────────────────────────────────────┤
│  Step 3: 计算 Edge（模型 vs 市场的差异）                  │
│  Edge = 模型概率 - 市场定价 = 83% - 55% = +28%          │
├─────────────────────────────────────────────────────┤
│  Step 4: 交易决策（三重过滤）                             │
│  ① 置信度过滤: 模型置信度 >= 80% 才交易                   │
│  ② 严格模式: 只允许交易方向与模型预测方向一致               │
│  ③ Edge 过滤: Edge > 5% 阈值才交易                       │
│  全部通过 → 买入 $1 的对应 token                         │
└─────────────────────────────────────────────────────┘
```

### 4.3 四种场景

| 场景 | 模型 | 市场 | Edge | 决策 |
|------|------|------|------|------|
| 模型看涨 + 市场低估 | P(Up)=83% | Up=$0.55 | +28% | ✅ 买 Up token |
| 模型看跌 + 市场低估 | P(Up)=5% | Down=$0.30 | +65% | ✅ 买 Down token |
| 模型看涨 + 市场更看涨 | P(Up)=57% | Up=$0.84 | -27% | ❌ 不交易（没优势） |
| 模型看涨 + 差异太小 | P(Up)=60% | Up=$0.58 | +2% | ❌ 不交易（edge不够） |

### 4.4 盈亏计算

```
买入 $1 的 Up token @ $0.55
→ 获得 1/0.55 = 1.818 份

如果金价上涨（Up 赢）:
  收入 = 1.818 × $1 = $1.818
  盈利 = $1.818 - $1.00 = +$0.82  (+81.8%)

如果金价下跌（Down 赢）:
  收入 = 1.818 × $0 = $0
  亏损 = $0 - $1.00 = -$1.00  (-100%)
```

**关键特性**: 每笔最多亏 $1，但盈利无上限（买入价越低，盈利倍数越高）。

---

## 五、回测方法

### 5.1 回测数据

- **时间范围**: 2025 年 10 月 ~ 2026 年 2 月
- **事件数量**: 47 个已结算的 Gold GC Up/Down 事件
- **实际结果分布**: Up = 28 (60%) | Down = 19 (40%)
- **价格数据**: 每个事件的小时级 K 线（通过 Dome API 获取）

### 5.2 回测流程

```
Step 1: 获取 Polymarket 历史数据
  └─ 通过 Dome API 搜索所有已结算的 "Gold GC Up or Down" 事件
  └─ 获取每个事件的小时级 K 线（Up/Down token 价格）
  └─ 获取每个事件的结算结果（Up 赢还是 Down 赢）

Step 2: 对每个事件运行 AI 模型预测
  └─ 站在前一天视角（只用 target_date 之前的数据）
  └─ 获取历史金价 + 10 个宏观指标
  └─ 训练 Logistic 回归 → 输出 P(Up)

Step 3: 模拟交易
  └─ 遍历每个事件的每个小时级价格点
  └─ 置信度过滤 → 严格模式过滤 → Edge 过滤
  └─ 通过全部过滤 → 买入 $1 的对应 token

Step 4: 结算 & 统计
  └─ 买对方向 → 盈利 = (1 - 买入价) / 买入价
  └─ 买错方向 → 亏损 = -$1
  └─ 汇总: 胜率、总盈亏、ROI、最大回撤、夏普比率
```

### 5.3 指标定义

| 指标 | 公式 |
|------|------|
| **胜率** | 盈利交易数 / 总交易数 |
| **总盈亏 (PnL)** | Σ 每笔交易盈亏 |
| **ROI** | 总盈亏 / 总投入 × 100% |
| **最大回撤** | 权益曲线从峰值到谷值的最大跌幅 |
| **Sharpe (简化)** | mean(每笔PnL) / std(每笔PnL) |

---

## 六、回测结果

### 6.1 策略优化历程

| 版本 | 策略 | 胜率 | ROI | Sharpe |
|------|------|------|-----|--------|
| V1 原始模式 | 双向交易，无过滤 | 38.4% | +51.1% | 0.117 |
| V2 严格模式 | 只跟模型方向交易 | 51.0% | +58.3% | 0.140 |
| **V3 最终版** | **严格模式 + 置信度≥80%** | **72.0%** | **+56.1%** | **0.335** |

### 6.2 最终回测结果（V3：严格模式 + 置信度≥80%）

| 指标 | 数值 |
|------|------|
| 参与事件 | 19 个（2025.10 ~ 2026.02） |
| 总交易笔数 | 175 笔（平均每事件 9.2 笔） |
| 胜率 | **72.0%**（126 胜 49 负） |
| 总投入 | $175.00 |
| 总盈亏 | **+$98.21** |
| 投资回报率 | **+56.1%** |
| 每笔平均盈亏 | +$0.56 |
| 盈利笔均盈 | +$1.17（赢的时候赚得多） |
| 亏损笔均亏 | -$1.00（输的时候最多亏 $1） |
| 单笔最大盈利 | +$10.11 |
| 单笔最大亏损 | -$1.00 |
| 最大回撤 | $26.00 |
| 夏普比率 | **0.335** |
| 模型方向准确率 | **72.2%**（13/18 事件） |

### 6.3 不同 Edge 阈值对比（严格模式 + 置信度≥80%）

| Edge 阈值 | 交易数 | 胜率 | 总盈亏 | ROI | 最大回撤 | Sharpe |
|-----------|--------|------|--------|-----|----------|--------|
| 2% | 196 | 72.4% | +$99.66 | +50.8% | $26.00 | 0.318 |
| **5%** | **175** | **72.0%** | **+$98.21** | **+56.1%** | **$26.00** | **0.335** |
| 8% | 161 | 72.0% | +$98.21 | +61.0% | $26.00 | 0.345 |
| 10% | 150 | 72.0% | +$97.21 | +64.8% | $26.00 | 0.354 |
| 15% | 131 | 71.0% | +$93.20 | +71.1% | $26.00 | 0.361 |
| 20% | 116 | 69.8% | +$88.93 | +76.7% | $26.00 | 0.362 |

### 6.4 按事件明细（V3 策略）

| 日期 | 模型P(Up) | 实际 | 交易方向 | 交易数 | 盈/亏 | 净盈亏 | ROI |
|------|-----------|------|----------|--------|-------|--------|-----|
| 2025-10-27 | 77.0% | Down | Up | 12 | 0/12 | -$12.00 | -100% |
| 2025-10-28 | 77.0% | Down | Up | 5 | 0/5 | -$5.00 | -100% |
| 2025-11-05 | 90.6% | Up | Up | 5 | 5/0 | +$2.65 | +53% |
| 2025-11-06 | 92.5% | Down | Up | 2 | 0/2 | -$2.00 | -100% |
| 2025-12-09 | 80.4% | Up | Up | 1 | 1/0 | +$0.82 | +82% |
| 2025-12-23 | 82.6% | Up | Up | 5 | 5/0 | +$4.24 | +85% |
| 2025-12-29 | 77.9% | Down | Up | 22 | 0/22 | -$22.00 | -100% |
| 2025-12-30 | 77.9% | Up | Up | 6 | 6/0 | +$4.51 | +75% |
| 2026-01-05 | 83.3% | Up | Up | 7 | 7/0 | +$2.56 | +37% |
| 2026-01-06 | 83.3% | Up | Up | 6 | 6/0 | +$6.52 | +109% |
| 2026-01-12 | 82.4% | Up | Up | 6 | 6/0 | +$15.98 | +266% |
| 2026-01-13 | 82.4% | Down | Up | 5 | 0/5 | -$5.00 | -100% |
| 2026-01-20 | 84.9% | Up | Up | 24 | 24/0 | +$9.86 | +41% |
| 2026-01-21 | 84.9% | Up | Up | 1 | 1/0 | +$0.96 | +96% |
| 2026-01-22 | 81.4% | Up | Up | 15 | 15/0 | +$41.02 | +273% |
| 2026-01-30 | 81.0% | Down | Up | 14 | 0/14 | -$14.00 | -100% |
| 2026-02-04 | 97.7% | Up | Up | 19 | 19/0 | +$14.22 | +75% |
| 2026-02-05 | 10.9% | Down | Down | 16 | 16/0 | +$22.24 | +139% |
| 2026-02-06 | 14.2% | Up | Down | 16 | 0/16 | -$16.00 | -100% |

### 6.5 关键发现

1. **模型预测对 = 该事件全部盈利**：严格模式下，方向正确时所有交易都赢
2. **模型预测错 = 该事件全部亏损**：方向错误时，投入全部归零（每笔 -$1）
3. **盈亏不对称是盈利关键**：赢时平均赚 $1.17，亏时固定 $1 → 胜率 >50% 即可盈利
4. **置信度过滤大幅提升胜率**：从 51%（无过滤）→ 72%（≥80%），代价是事件数 47→19
5. **最大单事件盈利**: 2026-01-22 (+$41.02, ROI +273%)
6. **最大单事件亏损**: 2025-12-29 (-$22.00)，模型看涨但实际下跌，22 小时持续买入

---

## 七、运行方式

### 7.1 安装依赖

```bash
pip install -r gold_analyzer/requirements.txt
```

依赖：`openai`, `yfinance`, `python-dotenv`, `pandas`, `numpy`, `scikit-learn`, `feedparser`

### 7.2 实时预测

```bash
python gold_analyzer/main.py
# 交互式输入目标日期，输出完整分析报告
```

### 7.3 回测

```bash
# 最终策略（严格模式 + 置信度>=80%）
python gold_analyzer/run_backtest.py --model --edge 0.05 --strict --min-conf 0.80

# 严格模式（无置信度过滤）
python gold_analyzer/run_backtest.py --model --edge 0.05 --strict

# 原始模式（双向交易）
python gold_analyzer/run_backtest.py --model --edge 0.05

# 参数扫描
python gold_analyzer/run_backtest.py --sweep

# 重新获取数据 + 重新预测
python gold_analyzer/run_backtest.py --model --refresh --refresh-predictions --strict --min-conf 0.80
```

### 7.4 命令行参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--model` | - | 使用 AI 回归模型动态预测 |
| `--edge` | 0.05 | 最小 Edge 阈值（5%） |
| `--strict` | - | 严格模式：只跟模型方向交易 |
| `--min-conf` | 0.0 | 最低置信度阈值（推荐 0.80） |
| `--bet` | 1.0 | 每笔投注金额 |
| `--model-mode` | fast | fast=仅回归, full=回归+AI |
| `--refresh` | - | 强制重新获取 Polymarket 数据 |
| `--refresh-predictions` | - | 强制重新运行模型预测 |
| `--sweep` | - | 固定概率参数扫描模式 |

---

## 八、文件结构

```
gold_analyzer/
├── main.py                    # 实时预测入口（8步完整流程）
├── run_backtest.py            # 回测入口（命令行参数、报告输出）
│
├── price_fetcher.py           # 历史金价获取（Yahoo Finance）
├── news_fetcher.py            # 黄金新闻抓取（RSS）
├── factor_collector.py        # AI 因素收集（大模型提取关键因素）
├── deep_analyzer.py           # AI 深度分析（看涨/看跌判断）
├── factor_data.py             # 代理指标选择 + 数据获取
├── regression.py              # Logistic 回归模型 + 概率融合
├── scoring.py                 # 量化评分
├── reporting.py               # 报告生成
│
├── ai_client.py               # AI 大模型客户端（Qwen/OpenAI）
├── config.py                  # 配置文件
├── .env                       # API 密钥
│
├── polymarket_client.py       # Polymarket 数据客户端（Dome API）
├── model_predictor.py         # 回测用模型预测器（站在前一天预测）
├── backtester.py              # 回测引擎（交易决策、盈亏计算）
│
├── gc_events_cache.json       # Polymarket 事件数据缓存
├── model_predictions_cache.json  # 模型预测结果缓存
├── requirements.txt           # Python 依赖
│
├── README.md                  # 本文件
├── ALL_CODE.md                # 完整代码（Markdown 格式）
├── BACKTEST_README.md         # 回测思路详解
└── BACKTEST_RESULTS.md        # 回测结果详细数据
```

---

## 九、API 与数据源

| 数据源 | 用途 | API |
|--------|------|-----|
| Yahoo Finance | 黄金价格 + 宏观指标 | `yfinance` Python 库 |
| RSS Feeds | 黄金相关新闻 | Google News / Investing.com |
| Qwen / OpenAI | AI 因素分析 + 深度判断 | OpenAI 兼容 API |
| Dome API | Polymarket 事件 + K线 | `api.domeapi.io/v1/polymarket` |
